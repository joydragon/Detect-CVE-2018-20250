#!/bin/bash

if [ $# -ne 1 ]; then
	echo >&2 "ERROR: Faltan el parametro del archivo"
	exit 1;
fi

FILE="$1"

FILETYPE=$(file "$FILE")
STRINGS=$(strings -n 10 "$FILE")

function malware_extract_startmenu {
	EXTRACT=$(acefile-unace -l "$FILE" 2> /dev/null | grep "Start Menu")
	echo "Extrayendo archivo malicioso en: \"$EXTRACT\""
	acefile-unace -x "$FILE" "$EXTRACT" > /dev/null
}

if [[ "$FILE" =~ ".rar" && "$FILETYPE" =~ "ACE archive data version 20, from Win/32, version 20 to extract, contains AV-String (unregistered), solid" ]]; then
	echo "Archivo comprimido ACE"
	RES=$(echo -e "$STRINGS" | grep -e '.:\\.:.:\.\.\/')
	if [ -n "$RES" ]; then
		# Caso 1: Insertar en carpeta Startup
		if [[ "$RES"  =~ 'Microsoft\Windows\Start Menu\Programs\Startup' ]]; then
			echo "Malware Detectado, Caso 1: insertado en Startup del usuario"
			hash acefile-unace 2>/dev/null || { echo >&2 "Error: Se necesita instalar el programa 'acefile-unace', favor instalarlo para proceder a la extraccion."; exit 1; }
			echo -e $(malware_extract_startmenu "$FILE")
		fi
	else
		echo "ERROR: No se encontro el formato de escape en el archivo."
	fi
else
	echo "ERROR: Archivo no esta comprimido con formato ACE."
fi
